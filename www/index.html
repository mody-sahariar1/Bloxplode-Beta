<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Bloxplode</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600;700;800;900&family=Rubik+Mono+One&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="menu.css">
    <link rel="stylesheet" href="global-settings.css">
    </head>
<body>

    <div id="bg-particles" class="particles-layer">
        <div class="cube c1"></div><div class="cube c2"></div><div class="cube c3"></div>
        <div class="cube c4"></div><div class="cube c5"></div><div class="cube c6"></div>
        <div class="cube c7"></div><div class="cube c8"></div><div class="cube c9"></div>
        <div class="cube c10"></div><div class="cube c11"></div><div class="cube c12"></div>
    </div>

    <div id="stratos-splash">
        <div class="studio-container">
            <div class="diamond-icon">‚óÜ</div>
            <div class="studio-text" data-text="STRATOS">STRATOS</div>
            <div class="studio-sub">GAMES</div>
        </div>
    </div>

    <div id="game-boot-layer">
        <div class="logo-wrapper" id="master-logo">
            <img src="logo.png" alt="BLOXPLODE" class="main-logo-img">
        </div>
        <div class="loading-zone" id="loader">
            <div class="loading-label">LOADING...</div>
            <div class="progress-track"><div class="progress-fill"></div></div>
        </div>
    </div>

    <div class="bottom-ui-layer hidden" id="menu-buttons-layer">
        <div id="main-menu" class="button-stack">
            <a href="classic/index.html" class="pill-btn green-pill">
                <div class="mini-grid-icon"><div class="mg-cell">‚àû</div></div>
                <span class="pill-text">Classic</span>
            </a>
            
            <button onclick="openAdventureMap()" class="pill-btn orange-pill">
                <div class="mini-grid-icon"><div class="mg-cell">üíé</div><div class="mg-cell">‚è±Ô∏è</div></div>
                <span class="pill-text">Adventure</span>
            </button>
        </div>
    </div>

    <div id="adventure-map-screen" class="map-overlay hidden">
        <div class="adv-header">
            <div class="trophy-icon">üèÜ</div>
            <div class="adv-title-group">
                <h1>Adventure</h1>
                <p>Win the Trophy!</p>
            </div>
        </div>

        <div class="structure-container">
            <div id="level-grid-structure" class="pixel-structure"></div>
        </div>

        <div class="bottom-action-panel">
            <a href="#" id="play-current-btn" class="big-play-btn">PLAY LEVEL 1</a>
            <div class="nav-tabs">
                <button onclick="closeAdventureMap()" class="nav-tab"><span class="tab-icon">üè†</span></button>
                <div class="nav-tab active"><span class="tab-icon">üíé</span></div>
            </div>
        </div>
    </div>

   <script>
        window.onload = function() {
            // --- BOOT SEQUENCE REFERENCES ---
            const stratos = document.getElementById('stratos-splash');
            const bootLayer = document.getElementById('game-boot-layer');
            const masterLogo = document.getElementById('master-logo');
            const loader = document.getElementById('loader');
            const menuButtons = document.getElementById('menu-buttons-layer');
            const particles = document.getElementById('bg-particles');

            // 1. DIRECT LINK CHECK (The Fix)
            // If the URL contains '?returnTo=adventure', skip intro and open map immediately
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('returnTo') === 'adventure') {
                // Kill Intro Animations
                stratos.style.display = 'none';
                loader.style.display = 'none';
                
                // Prepare Environment
                sessionStorage.setItem('gameStarted', 'true');
                particles.classList.add('active');
                
                // Hide Boot Layer & Logo (Map needs them hidden)
                bootLayer.style.display = 'none'; 
                masterLogo.classList.add('hidden');
                
                // Open The Map
                generateStructure(); // Ensure grid is built
                openAdventureMap();  // Show the map screen
                return; // Stop the rest of the boot sequence
            }

            // 2. CHECK TUTORIAL STATUS
            const isTutorialDone = localStorage.getItem('blox_tutorial_done') === 'true';

            // 3. SESSION CHECK (Have we seen the intro yet?)
            if (sessionStorage.getItem('gameStarted') === 'true') {
                // SKIP INTRO
                stratos.style.display = 'none'; 
                loader.style.display = 'none';
                
                if (!isTutorialDone) {
                    window.location.href = 'classic/index.html';
                    return; 
                }

                masterLogo.classList.add('move-to-header'); 
                masterLogo.style.transition = 'none';
                menuButtons.classList.remove('hidden'); 
                menuButtons.classList.add('animate-entry');
                particles.classList.add('active'); 
                setTimeout(() => masterLogo.style.transition = '', 100);

            } else {
                // PLAY FULL INTRO
                sessionStorage.setItem('gameStarted', 'true');
                
                setTimeout(() => { stratos.classList.add('fade-out'); bootLayer.classList.add('active'); }, 4000);
                setTimeout(() => { 
                    loader.style.opacity = '0'; 
                    setTimeout(() => loader.style.display = 'none', 200); 
                }, 8800);

                setTimeout(() => { 
                    if (!isTutorialDone) {
                        window.location.href = 'classic/index.html';
                    } else {
                        masterLogo.classList.add('move-to-header'); 
                        menuButtons.classList.remove('hidden'); 
                        menuButtons.classList.add('animate-entry'); 
                        particles.classList.add('active');
                    }
                    setTimeout(() => stratos.style.display = 'none', 500);
                }, 9000);
            }

            generateStructure();
            window.addEventListener('popstate', closeMapUI);
        };

        function generateStructure() {
            const container = document.getElementById('level-grid-structure');
            const playBtn = document.getElementById('play-current-btn');
            
            const currentMaxLevel = parseInt(localStorage.getItem('blox_adv_progress')) || 1;

            playBtn.innerHTML = `PLAY LEVEL ${currentMaxLevel}`;
            playBtn.href = `bloxplode adventure level ${currentMaxLevel}/index.html`;

            // 12 Rows. 90 Levels Total.
            const trophyGrid = [
                [0,0,1,1,1,1,1,1,0,0], 
                [0,1,1,1,1,1,1,1,1,0], 
                [1,1,1,1,1,1,1,1,1,1], 
                [1,1,1,1,1,1,1,1,1,1], 
                [0,1,1,1,1,1,1,1,1,0], 
                [0,0,1,1,1,1,1,1,0,0], 
                [0,0,0,1,1,1,1,0,0,0], 
                [0,0,0,1,1,1,1,0,0,0], 
                [0,0,1,1,1,1,1,1,0,0], 
                [0,1,1,1,1,1,1,1,1,0], 
                [1,1,1,1,1,1,1,1,1,1], 
                [1,1,1,1,1,1,1,1,1,1], 
            ];
            
            let rowsHTML = [];
            let levelCounter = 1;

            for (let r = trophyGrid.length - 1; r >= 0; r--) {
                let rowHTML = '<div class="struct-row">';
                for (let c = 0; c < 10; c++) {
                    if (trophyGrid[r][c] === 1) {
                        let lvl = levelCounter;
                        let classes = 'struct-block';
                        let isLocked = false;
                        if (lvl < currentMaxLevel) { classes += ' blue'; } 
                        else if (lvl === currentMaxLevel) { classes += ' gold pulse'; } 
                        else { classes += ' locked'; isLocked = true; }

                        if (isLocked) { rowHTML += `<div class="${classes}">${lvl}</div>`; } 
                        else { rowHTML += `<a href="bloxplode adventure level ${lvl}/index.html" class="${classes}">${lvl}</a>`; }
                        levelCounter++;
                    } else {
                        rowHTML += `<div class="struct-block empty"></div>`;
                    }
                }
                rowHTML += '</div>';
                rowsHTML.unshift(rowHTML); 
            }
            container.innerHTML = rowsHTML.join('');
        }

        function openAdventureMap() {
            history.pushState({ modal: 'adventure' }, 'Adventure', '#adventure');
            
            // Ensure main menu elements are hidden
            document.getElementById('menu-buttons-layer').classList.add('hidden');
            document.getElementById('master-logo').classList.add('hidden');
            
            const mapScreen = document.getElementById('adventure-map-screen');
            mapScreen.classList.remove('hidden');
            setTimeout(() => { mapScreen.classList.add('active'); }, 10);
        }

      function closeAdventureMap() {
            closeMapUI();
        }

        // FIXED: HANDLES RE-ENTRY FROM 'RETURNTO' PARAM
        function closeMapUI() {
            const mapScreen = document.getElementById('adventure-map-screen');
            
            mapScreen.classList.remove('active');
            
            setTimeout(() => {
                mapScreen.classList.add('hidden');
                
                // 1. Restore Parent Boot Layer (Was hidden by returnTo logic)
                document.getElementById('game-boot-layer').style.display = 'flex';

                // 2. Restore Main Menu & Add Animation Class (Fixes Opacity 0 bug)
                const menuLayer = document.getElementById('menu-buttons-layer');
                menuLayer.classList.remove('hidden');
                menuLayer.classList.add('animate-entry');

                // 3. Restore Logo
                document.getElementById('master-logo').classList.remove('hidden');
                document.getElementById('master-logo').classList.add('move-to-header'); 
            }, 300);
        }
    </script>
          <script src="env.js"></script>
    <script src="global-settings.js"></script>
</body>
</html>