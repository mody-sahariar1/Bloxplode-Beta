/* --- 1. CORE LAYOUT & RESET --- */
@import url('https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,600;0,700;1,900&family=Nunito:wght@700;800;900&display=swap');

* { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }

:root {
    /* --- VIBRANT ROYAL BLUE THEME --- */
    --bg-friendly-top: #566CD5; 
    --bg-friendly-bot: #3E50A4; 
    
    /* --- DARK ARENA COLORS --- */
    --bg-grid-center: #1A1D24; 
    --bg-grid-edge:   #111318; 
    
    --bg-panel: #1A1D24;        
    --bg-cell:  #262A35;        
    --text-main: #E2E8F0;       
    --text-muted: #8FA3BF; 
    
    /* --- TRAY BAYS --- */
    --bg-tray: transparent; 
    
    /* Radius Standards */
    --rad-grid: 12px;
    --rad-block: 6px;
    --rad-cell: 4px;

    /* DYNAMIC HEXAGON STATE */
    --hex-opacity: 0;        
    --hex-start: #2980b9;    
    --hex-end: #3498db;      
}

body { 
    background: linear-gradient(180deg, var(--bg-friendly-top) 0%, var(--bg-friendly-bot) 100%);
    color: var(--text-main); 
    font-family: 'Nunito', sans-serif; 
    text-align: center; 
    margin: 0; 
    display: flex; 
    justify-content: center; 
    min-height: 100vh; 
    overflow: hidden; 
    padding-top: 60px;
    overscroll-behavior: none;
}

.game-column { 
    width: 404px; 
    display: flex; 
    flex-direction: column; 
    align-items: center;
    transform-origin: top center;
    transition: transform 0.1s linear; 
    position: relative;
}
.hidden { display: none !important; }

/* =====================================================
   HEADER RESTRUCTURING (ABSOLUTE HUD)
   ===================================================== */
.top-bar { 
    width: 100%; 
    height: 100px; 
    position: relative; 
    margin-bottom: 20px; 
}

/* 1. MAIN SCORE (CENTER, FLOATING) */
.score-box:first-child {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    min-width: auto;
    
    display: flex;
    justify-content: center;
    align-items: center;
    
    overflow: visible; 
    z-index: 10;
    
    transition: transform 0.1s;
}

/* IMPACT POP EFFECT */
.score-box:first-child.pulse-trigger {
    animation: impact-pop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes impact-pop {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.3); } 
    100% { transform: translate(-50%, -50%) scale(1); }
}

.score-box:first-child .label { display: none; }

/* FONT: Nunito (76px) */
#score { 
    font-family: 'Nunito', sans-serif;
    font-size: 76px; 
    font-weight: 900; 
    color: #ffffff;
    letter-spacing: -2px;
    line-height: 1;
    z-index: 2;
    text-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-variant-numeric: tabular-nums;
}

/* 2. BEST SCORE (TOP LEFT - LIFTED HIGHER) */
.score-box:last-child {
    position: absolute;
    /* ADJUSTED: Lifted from -15px to -25px (Higher up) */
    top: -25px; 
    left: 0; 
    
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    min-width: auto;
    
    display: flex;
    flex-direction: row; 
    align-items: center;
    gap: 6px;
}

.score-box:last-child .label { font-size: 0; } 

.score-box:last-child .label::before {
    content: 'ðŸ‘‘'; 
    font-size: 24px; 
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
}

#best-score { 
    font-family: 'Nunito', sans-serif;
    font-size: 24px; 
    font-weight: 800; 
    color: #FFD700; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* =====================================================
   THE PULSATING HEXAGON
   ===================================================== */
.score-box:first-child::before {
    content: '';
    position: absolute;
    top: 52%; left: 50%;
    
    /* Size: 50px */
    width: 50px; height: 50px;
    
    transform: translate(-50%, -50%) scale(0);
    
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    
    background: linear-gradient(135deg, var(--hex-start), var(--hex-end));
    box-shadow: 0 0 25px var(--hex-start); 
    
    z-index: -1; 
    opacity: 0;
    
    /* Transitions for Entry/Dimming */
    transition: opacity 0.4s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* --- STATE 0: FULL COMBO --- */
body.combo-active[data-grace="0"] .score-box:first-child::before {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1; 
    animation: hex-pulse 0.8s ease-in-out infinite;
}

/* --- STATE 1: MISS 1 (Dimmed) --- */
body.combo-active[data-grace="1"] .score-box:first-child::before {
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0.6; 
    animation: hex-pulse 1.2s ease-in-out infinite; 
    filter: saturate(0.8);
}

/* --- STATE 2: MISS 2 (Dimmest) --- */
body.combo-active[data-grace="2"] .score-box:first-child::before {
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0.3; 
    animation: hex-pulse 2s ease-in-out infinite;
    filter: saturate(0.5);
}

@keyframes hex-pulse {
    0% { transform: translate(-50%, -50%) scale(1.0); }
    50% { transform: translate(-50%, -50%) scale(1.15); }
    100% { transform: translate(-50%, -50%) scale(1.0); }
}

/* =====================================================
   COLOR TIERS
   ===================================================== */

/* Tier 1: CYAN (Combo 2-9) */
body.combo-active { 
    --hex-start: #00f2fe; 
    --hex-end: #4facfe; 
}

/* Tier 2: GOLD (Combo 10+) */
body:has(.combo-popup[style*="feca57"]),
body:has(.combo-popup[style*="5f27cd"]),
body:has(.combo-popup[style*="ff6b6b"]),
body:has(.combo-popup[style*="f1c40f"]),
body:has(.combo-popup[style*="00ffcc"]) { 
    --hex-start: #FFD700; /* Pure Gold */
    --hex-end: #FFA500;   /* Orange Gold */
}


/* --- GRID (STAGE LIGHTING) --- */
#grid-wrapper { 
    background: radial-gradient(circle at center, var(--bg-grid-center) 0%, var(--bg-grid-edge) 85%);
    padding: 12px; 
    border-radius: var(--rad-grid); 
    width: 404px; 
    height: 404px; 
    position: relative; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.55);
    margin-top: 0px; 
    overflow: visible; 
    z-index: 1; 
}

#grid { display: grid; grid-template-columns: repeat(8, 44px); gap: 4px; }

/* EMPTY CELLS */
.cell { 
    width: 44px; 
    height: 44px; 
    background: var(--bg-cell); 
    border-radius: var(--rad-cell); 
    position: relative;
    z-index: 1; 
}

/* OCCUPIED BLOCKS (HARD CHISELED) */
.cell.occupied { 
    background: var(--block-color); 
    border-radius: var(--rad-block);
    opacity: 1 !important; 
    z-index: 2; 
    box-shadow: 
        inset 3px 3px 0px 0px rgba(255,255,255,0.4),
        inset -3px -3px 0px 0px rgba(0,0,0,0.2);
}

/* =====================================================
   CLEAR RESOLUTION
   ===================================================== */
.clear-resolve {
    z-index: 50; 
    background: var(--block-color);
    border-radius: var(--rad-block);
}

/* =====================================================
   PLACEMENT GLOW
   ===================================================== */
.placed-impact { 
    animation: place-pop 0.3s ease-out forwards; 
    z-index: 15; 
}

@keyframes place-pop {
    0% { transform: scale(0.8); filter: brightness(1.3); }
    60% { transform: scale(1.05); }
    100% { transform: scale(1); filter: brightness(1); }
}

/* =====================================================
   GHOST PREVIEWS (HIGH BEAMS)
   ===================================================== */
@keyframes preview-pulse {
    0% { opacity: 0.5; transform: scale(0.95); filter: brightness(1); }
    100% { opacity: 0.8; transform: scale(1); filter: brightness(1.3); }
}

.cell.ghost { 
    background: var(--block-color); 
    border-radius: var(--rad-block);
    z-index: 100;
    opacity: 0.5 !important; 
    border: 1px solid rgba(255,255,255,0.3); 
    animation: preview-pulse 1.2s ease-in-out alternate infinite;
    box-shadow: none; 
}

.cell.ghost-clear {
    background: var(--preview-color) !important;
    border-radius: var(--rad-block);
    z-index: 100;
    border: 1px solid rgba(255,255,255,0.6); 
    animation: clear-pulse 0.6s ease-in-out alternate infinite;
}

@keyframes clear-pulse {
    0% { opacity: 0.6; filter: brightness(1.3); transform: scale(0.96); }
    100% { opacity: 1.0; filter: brightness(1.6); transform: scale(1); }
}

/* --- TRAY (INVISIBLE & FLOATING) --- */
#tray { 
    width: 100%; 
    margin-top: 30px; 
    display: flex; 
    justify-content: space-between; 
    height: 120px; 
    transition: opacity 0.3s;
}

.tray-slot { 
    width: 128px; 
    height: 120px; 
    background: transparent; 
    border-radius: 12px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
}

.piece { position: relative; pointer-events: none; }

.tray-slot .piece {
    filter: saturate(0.9) brightness(0.95) drop-shadow(0 6px 6px rgba(0,0,0,0.15));
    transition: filter 0.2s;
}

.block { 
    position: absolute; 
    width: 26px; 
    height: 26px; 
    background: var(--block-color); 
    border-radius: 4px; 
    opacity: 1 !important; 
    box-shadow: 
        inset 2px 2px 0px 0px rgba(255,255,255,0.4),
        inset -2px -2px 0px 0px rgba(0,0,0,0.2);
}

.piece.dragging { position: fixed; z-index: 1000; pointer-events: none; }
.piece.dragging .block {
    width: 44px; height: 44px; 
    border-radius: var(--rad-block);
    opacity: 1 !important; 
    animation: none; transition: none;
    filter: none;
    box-shadow: 
        inset 3px 3px 0px 0px rgba(255,255,255,0.5),
        inset -3px -3px 0px 0px rgba(0,0,0,0.2),
        0 8px 15px rgba(0,0,0,0.3);
}
@media (pointer: coarse) {
    .piece.dragging .block { transform: scale(1.1); }
}

/* =====================================================
   FLOATING SCORE
   ===================================================== */
.floating-score {
    position: fixed;
    left: var(--start-x);
    top: var(--start-y);
    color: #ffffff;
    font-family: 'Kanit', sans-serif;
    font-weight: 700;
    font-size: 32px;
    pointer-events: none;
    z-index: 20006;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
    transform: translate(-50%, -50%);
    will-change: transform;
}

.score-animate { animation: score-travel 1s linear forwards; }

@keyframes score-travel {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
    10% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
    100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1); opacity: 0; }
}

/* =====================================================
   COMBO & REINFORCEMENT SYSTEM
   ===================================================== */

@keyframes shake-1 { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, -2px); } }
@keyframes shake-2 { 0%, 100% { transform: translate(0, 0); } 20% { transform: translate(-4px, 0); } 40% { transform: translate(4px, 0); } 60% { transform: translate(-4px, 0); } 80% { transform: translate(4px, 0); } }
@keyframes shake-3 { 0%, 100% { transform: translate(0, 0); } 10%, 90% { transform: translate(-5px, -2px); } 30%, 70% { transform: translate(5px, 3px); } 50% { transform: translate(-5px, 5px); } }

.shake-1 { animation: shake-1 0.1s linear; }
.shake-2 { animation: shake-2 0.12s linear; }
.shake-3 { animation: shake-3 0.15s linear; }

.combo-popup {
    position: absolute;
    top: 52%; 
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 20010;
    pointer-events: none;
    animation: combo-pop 0.98s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    will-change: transform;
}

.combo-label {
    font-family: 'Kanit', sans-serif;
    font-weight: 900;
    font-style: italic;
    font-size: 55px;
    color: #fff;
    -webkit-text-stroke: 2px #fff;
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    line-height: 1;
}

.combo-value {
    font-family: 'Kanit', sans-serif;
    font-weight: 900;
    font-style: italic;
    font-size: 88px;
    line-height: 1;
    margin-top: 8px;
    background: -webkit-linear-gradient(#fff, var(--combo-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    -webkit-text-stroke: 3px #fff;
    filter: drop-shadow(0 6px 0 var(--combo-color));
}

@keyframes combo-pop {
    0% { transform: translate(-50%, -20%) scale(0.5); opacity: 0; }
    40% { transform: translate(-50%, -60%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -80%) scale(1); opacity: 0; }
}

.reinforcement-banner {
    position: absolute;
    top: 38%;
    left: 0;
    width: 100%;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20020;
    pointer-events: none;
    
    background: linear-gradient(90deg, transparent, var(--combo-color), transparent);
    border-top: 2px solid var(--combo-color);
    border-bottom: 2px solid var(--combo-color);
    
    animation: banner-wipe 0.85s ease-out forwards;
    transform-origin: center;
    will-change: transform;
}

.banner-text {
    font-family: 'Rubik Mono One', sans-serif;
    font-size: 26px;
    color: #fff;
    letter-spacing: 5px;
    text-transform: uppercase;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    white-space: nowrap;
}

@keyframes banner-wipe {
    0% { transform: scaleX(0); opacity: 0; }
    20% { transform: scaleX(1); opacity: 1; }
    80% { transform: scaleX(1); opacity: 1; }
    100% { transform: scaleX(1.2); opacity: 0; }
}

#game-over-overlay { position: fixed; inset: 0; background: rgba(17, 19, 24, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; }

.game-over-box { 
    background: var(--bg-panel); 
    padding: 40px; 
    border-radius: 20px; 
    border: none;
    color: white; 
    text-align: center; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.game-over-box h1 { margin-top: 0; font-size: 32px; font-weight: 700; margin-bottom: 24px; }

#restart-overlay-btn { 
    background: #6CB0F9; 
    border: none; 
    padding: 16px 32px; 
    border-radius: 12px; 
    font-weight: 700; 
    color: #13151A; 
    cursor: pointer; 
    font-size: 16px;
    transition: transform 0.1s;
}
#restart-overlay-btn:hover { background: #8DC4FA; transform: scale(1.05); }
#restart-overlay-btn:active { transform: scale(0.95); }

/* =====================================================
   NEW BEST SCORE ANIMATION (TURBO PREMIUM VERSION)
   ===================================================== */

/* Container */
#new-best-overlay {
    position: absolute;
    inset: 0;
    z-index: 2000;
    pointer-events: none;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    /* Flashy background burst on trigger */
    background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 60%);
    animation: bg-flash 0.3s ease-out forwards;
}

@keyframes bg-flash {
    0% { opacity: 0; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1); }
}

.celebration-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

/* --- 1. THE CROWN (Optimized Duration) --- */

.crown-container {
    width: 110px;
    height: 110px;
    z-index: 10;
    transform-origin: center bottom;
    
    /* MODIFIED: Reduced to 2.0s to ensure it finishes before JS kills it */
    animation: crown-lifecycle 2.0s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* THE NEW 5-POINT BALL-TIPPED GOLD CROWN ICON */
.crown-svg {
    width: 100%;
    height: 100%;
    
    /* Custom Vector matching your reference: 5 points with ball tips, curved base */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FFD700'/%3E%3Cstop offset='50%25' style='stop-color:%23FDB931'/%3E%3Cstop offset='100%25' style='stop-color:%23FFD700'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g)' stroke='%23B8860B' stroke-width='1' d='M50 20 L65 45 L85 25 L80 55 L95 40 L90 75 Q50 85 10 75 L5 40 L20 55 L15 25 L35 45 Z' /%3E%3Ccircle cx='5' cy='40' r='3' fill='%23FFD700' stroke='%23B8860B'/%3E%3Ccircle cx='15' cy='25' r='3' fill='%23FFD700' stroke='%23B8860B'/%3E%3Ccircle cx='50' cy='20' r='4' fill='%23FFD700' stroke='%23B8860B'/%3E%3Ccircle cx='85' cy='25' r='3' fill='%23FFD700' stroke='%23B8860B'/%3E%3Ccircle cx='95' cy='40' r='3' fill='%23FFD700' stroke='%23B8860B'/%3E%3C/svg%3E");
    
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center bottom;
    
    /* Golden Glow Effect */
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.9));
}

/* COMPLETE LIFECYCLE: Optimized for 2.0s Timer */
@keyframes crown-lifecycle {
    /* PHASE 1: TURBO ENTRY */
    0% {
        transform: scale(2.0) translateY(30px);
        filter: drop-shadow(0 0 50px #FFF) brightness(3.0);
        opacity: 0;
    }
    15% {
        transform: scale(1.0) translateY(0); /* SLAM DOWN */
        filter: drop-shadow(0 0 20px #FFD700) brightness(1.2);
        opacity: 1;
    }
    30% {
        transform: scale(1.0) translateY(-22px); /* LIFT UP */
        filter: drop-shadow(0 4px 2px rgba(0,0,0,0.4)) brightness(1);
        opacity: 1;
    }
    
    /* PHASE 2: HOLD (Visible) */
    60% {
        transform: scale(1.0) translateY(-22px);
        opacity: 1;
    }
    
    /* PHASE 3: EARLY FADE OUT (Drift & Vanish) */
    100% {
        transform: scale(0.95) translateY(-80px); /* Drift Up High */
        opacity: 0;
    }
}

/* --- 2. THE BANNER (Synced Lifecycle) --- */
.best-banner {
    position: absolute;
    top: 75px; 
    z-index: 5;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* SYNCED TO 2.0s */
    animation: banner-lifecycle 2.0s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    animation-delay: 0.2s; /* Slight offset */
    opacity: 0;
}

@keyframes banner-lifecycle {
    /* PHASE 1: POP IN */
    0% {
        transform: scale(0.2) translateY(-20px);
        opacity: 0;
    }
    15% {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
    
    /* PHASE 2: HOLD */
    60% {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
    
    /* PHASE 3: FADE OUT */
    100% {
        transform: scale(0.9) translateY(10px); /* Drift Down */
        opacity: 0;
    }
}

/* The Silk Texture */
.ribbon-center {
    /* High Contrast Glossy Gradient */
    background: linear-gradient(180deg, #BA68C8 0%, #7B1FA2 45%, #4A148C 55%, #4A148C 100%);
    color: #FFF;
    padding: 6px 28px;
    
    font-family: 'Kanit', sans-serif;
    font-weight: 900;
    font-size: 22px;
    letter-spacing: 1px;
    text-transform: uppercase;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* 3D Structure */
    border-radius: 4px;
    border: 1px solid #BA68C8; /* Highlight rim */
    border-bottom: 3px solid #38006b; /* Thick bottom edge */
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    
    transform: perspective(200px) rotateX(5deg);
}

/* Dark Folded Tails */
.ribbon-tail-l, .ribbon-tail-r {
    position: absolute;
    top: 6px;
    z-index: -1;
    width: 24px; 
    height: 28px;
    background: #311B92; /* Very dark purple for depth */
    box-shadow: inset 0 0 5px rgba(0,0,0,0.6);
    border-radius: 2px;
}

.ribbon-tail-l { 
    left: -10px; 
    transform: skewY(20deg) scale(0.9); 
}
.ribbon-tail-r { 
    right: -10px; 
    transform: skewY(-20deg) scale(0.9); 
}

/* Quick Exit (Safety Net) */
.fade-out-best {
    animation: fade-overlay-out 1.0s ease-in forwards !important;
}

@keyframes fade-overlay-out {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.1); }
}

/* =====================================================
   STEP 2: GAME OVER SEQUENCE (FINAL POLISH)
   ===================================================== */

/* 1. The "Visual Fill" Block (The Bricks) */
.visual-fill {
    background: var(--block-color);
    border-radius: var(--rad-block);
    box-shadow: 
        inset 3px 3px 0px 0px rgba(255,255,255,0.4),
        inset -3px -3px 0px 0px rgba(0,0,0,0.2);
    
    /* Animation: Instant Pop-in */
    animation: fill-pop 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    position: relative;
    z-index: 10;
}

@keyframes fill-pop {
    0% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

/* 2. The Dimmed State (Lighting drop) */
.state-dimmed {
    filter: brightness(0.8) !important;
    transition: filter 0.4s ease;
}

/* 3. "No Space Left" Toast - REPOSITIONED */
#no-space-message {
    width: 100%;
    height: 60px;
    
    display: flex;
    justify-content: center;
    align-items: center;
    
    font-family: 'Kanit', sans-serif;
    font-weight: 900;
    font-size: 28px;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    
    position: absolute;
    /* MOVED UP: Was bottom:50px, now bottom:70px to float over Tray area */
    bottom: 70px; 
    left: 0;
    z-index: 100;
    
    background: rgba(26, 29, 36, 0.95);
    border-radius: 12px;
    
    animation: msg-slide-up 0.3s ease-out forwards;
}

@keyframes msg-slide-up {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

#no-space-message.hidden { display: none; }

/* ============================================
   NEON SNAP VFX
   ============================================ */

.fx-dying-block {
    position: absolute;
    width: 44px;
    height: 44px;
    background: var(--color);
    border-radius: 6px;
    z-index: 500;
    pointer-events: none;
    will-change: transform, opacity;
}

.anim-implode { animation: implode 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
@keyframes implode {
    0% { transform: scale(1); filter: brightness(1); opacity: 1; }
    40% { transform: scale(0.9); filter: brightness(2); opacity: 1; }
    100% { transform: scale(0.2); filter: brightness(5); opacity: 0; }
}

.fx-core-flash {
    position: absolute;
    width: 44px;
    height: 44px;
    background: #FFFFFF;
    box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.8);
    border-radius: 6px;
    z-index: 600;
    pointer-events: none;
    animation: core-flash-pop 0.3s ease-out forwards;
}

@keyframes core-flash-pop {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
}

.fx-laser-beam {
    position: absolute;
    background: #fff;
    box-shadow: 0 0 15px var(--color); 
    border-radius: 4px;
    z-index: 400;
    pointer-events: none;
    opacity: 0.8;
}

.laser-h { height: 2px; width: 0; animation: laser-wipe-h 0.3s ease-out forwards; }
.laser-v { width: 2px; height: 0; animation: laser-wipe-v 0.3s ease-out forwards; }
@keyframes laser-wipe-h { 0% { width: 0; opacity: 1; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0; } }
@keyframes laser-wipe-v { 0% { height: 0; opacity: 1; } 50% { height: 100%; opacity: 1; } 100% { height: 100%; opacity: 0; } }

.fx-spark {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--color);
    box-shadow: 0 0 4px var(--color);
    border-radius: 1px;
    z-index: 550;
    pointer-events: none;
    animation: spark-fly 0.5s ease-out forwards;
}
@keyframes spark-fly {
    0% { transform: translate(0, 0) scale(1.5); opacity: 1; }
    60% { opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
}

@keyframes flashbang-dim { 0% { background: rgba(255,255,255,0.2); } 100% { background: transparent; } }
.flashbang-active { animation: flashbang-dim 0.15s linear; }

/* ============================================
   NEON RIM & STATIC LIGHT FX (GPU OPTIMIZED)
   ============================================ */

#grid-wrapper::after, #grid-wrapper::before {
    content: '';
    position: absolute;
    border-radius: var(--rad-grid);
    pointer-events: none;
    opacity: 0; 
}

/* Screen Flash */
#grid-wrapper::after {
    inset: 0;
    z-index: 5;
    background: var(--flash-color, #fff);
    mix-blend-mode: screen; 
}

/* Neon Rim */
#grid-wrapper::before {
    inset: -4px; 
    z-index: -1;
    border: 3px solid var(--flash-color, transparent);
    box-shadow: 0 0 20px var(--flash-color, transparent);
}

@keyframes gpu-flash {
    0% { opacity: 1; }
    100% { opacity: 0; }
}

/* TRIGGERS */
#grid-wrapper:has(.combo-popup[style*="00d2d3"]) { --flash-color: #00d2d3; }
#grid-wrapper:has(.combo-popup[style*="00d2d3"])::after { animation: gpu-flash 0.5s ease-out forwards; }
#grid-wrapper:has(.combo-popup[style*="00d2d3"])::before { animation: gpu-flash 0.5s ease-out forwards; }

#grid-wrapper:has(.combo-popup[style*="ff9ff3"]) { --flash-color: #ff9ff3; }
#grid-wrapper:has(.combo-popup[style*="ff9ff3"])::after { animation: gpu-flash 0.5s ease-out forwards; }
#grid-wrapper:has(.combo-popup[style*="ff9ff3"])::before { animation: gpu-flash 0.5s ease-out forwards; }

#grid-wrapper:has(.combo-popup[style*="54a0ff"]) { --flash-color: #54a0ff; }
#grid-wrapper:has(.combo-popup[style*="54a0ff"])::after { animation: gpu-flash 0.5s ease-out forwards; }
#grid-wrapper:has(.combo-popup[style*="54a0ff"])::before { animation: gpu-flash 0.5s ease-out forwards; }

/* Max Tier */
#grid-wrapper:has(.combo-popup[style*="feca57"]),
#grid-wrapper:has(.combo-popup[style*="5f27cd"]),
#grid-wrapper:has(.combo-popup[style*="ff6b6b"]),
#grid-wrapper:has(.combo-popup[style*="f1c40f"]),
#grid-wrapper:has(.combo-popup[style*="00ffcc"]) { --flash-color: #fff; }

#grid-wrapper:has(.combo-popup[style*="feca57"]) { --flash-color: #feca57; }
#grid-wrapper:has(.combo-popup[style*="5f27cd"]) { --flash-color: #5f27cd; }
#grid-wrapper:has(.combo-popup[style*="ff6b6b"]) { --flash-color: #ff6b6b; }
#grid-wrapper:has(.combo-popup[style*="f1c40f"]) { --flash-color: #f1c40f; }
#grid-wrapper:has(.combo-popup[style*="00ffcc"]) { --flash-color: #00ffcc; }

#grid-wrapper:has(.combo-popup[style*="feca57"])::after, #grid-wrapper:has(.combo-popup[style*="feca57"])::before,
#grid-wrapper:has(.combo-popup[style*="5f27cd"])::after, #grid-wrapper:has(.combo-popup[style*="5f27cd"])::before,
#grid-wrapper:has(.combo-popup[style*="ff6b6b"])::after, #grid-wrapper:has(.combo-popup[style*="ff6b6b"])::before,
#grid-wrapper:has(.combo-popup[style*="f1c40f"])::after, #grid-wrapper:has(.combo-popup[style*="f1c40f"])::before,
#grid-wrapper:has(.combo-popup[style*="00ffcc"])::after, #grid-wrapper:has(.combo-popup[style*="00ffcc"])::before {
    animation: gpu-flash 0.5s ease-out forwards;
}