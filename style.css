* { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
body { 
    background: #4facfe; color: #fff; font-family: 'Varela Round', sans-serif; 
    text-align: center; margin: 0; 
    display: flex; justify-content: center; 
    min-height: 100vh; width: 100vw; 
    overflow: hidden; 
    padding-top: 20px; 
}

/* --- CLOUDS --- */
#clouds-layer { position: fixed; inset: 0; z-index: -3; pointer-events: none; overflow: hidden; }
.cloud { 
    position: absolute; 
    background: rgba(255, 255, 255, 0.4); 
    border-radius: 50px; 
    box-shadow: 0 0 20px rgba(255,255,255,0.1); 
    animation: float-cloud linear infinite;
    transition: background 2s ease, opacity 2s ease;
}
.cloud.dark { background: rgba(80, 90, 100, 0.5); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
.cloud::after, .cloud::before { content: ''; position: absolute; background: inherit; border-radius: 50%; }
.cloud::after { top: -40%; left: 10%; width: 40%; height: 100%; }
.cloud::before { top: -55%; left: 30%; width: 50%; height: 120%; }
@keyframes float-cloud { 0% { transform: translateX(-200px); } 100% { transform: translateX(120vw); } }

/* --- HILLS --- */
.hills-container { position: fixed; inset: 0; z-index: -2; pointer-events: none; overflow: hidden; }
.hill { position: absolute; bottom: -60px; border-radius: 50% 50% 0 0; transition: transform 1s ease, background-color 3s ease; }
.hill-back { width: 140%; height: 35vh; left: -20%; background-color: #3c9632; opacity: 0.9; }
.hill-front { width: 140%; height: 25vh; right: -20%; background-color: #54b649; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }

/* --- NATURE ELEMENTS & WIND --- */
.leaf {
    position: absolute; width: 14px; height: 14px; background-color: #2ecc71;
    border-radius: 0px 12px; pointer-events: none; z-index: 25;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    transform-origin: top left;
    transform: rotate(var(--base-rot, 0deg)); 
    animation: leaf-breeze var(--sway-speed, 2s) ease-in-out infinite alternate;
    animation-delay: var(--sway-delay, 0s);
    transition: background-color 2s, filter 2s;
}
@keyframes leaf-breeze {
    0% { transform: rotate(var(--base-rot)) translate(0, 0); }
    100% { transform: rotate(calc(var(--base-rot) + 20deg)) translate(5px, 2px); }
}
.leaf.dark { background-color: #27ae60; width: 12px; height: 12px; border-radius: 12px 0px; }
.leaf.internal { opacity: 0.3; z-index: 0; }
.flower {
    position: absolute; width: 8px; height: 8px; background-color: #e91e63;
    border-radius: 50%; z-index: 26; box-shadow: 0 0 4px #ff80ab;
    transform: rotate(var(--base-rot, 0deg));
    animation: leaf-breeze var(--sway-speed, 2s) ease-in-out infinite alternate;
}

/* --- BUTTERFLIES --- */
.butterfly, .swarm-butterfly { position: fixed; width: 14px; height: 14px; pointer-events: none; }
.butterfly { z-index: 50; animation: flutter 12s infinite linear; transition: opacity 1s; }
.swarm-butterfly { z-index: 100001; transition: transform 0.1s linear; }
.butterfly::before, .butterfly::after, .swarm-butterfly::before, .swarm-butterfly::after {
    content: ''; position: absolute; top: 0; width: 7px; height: 10px;
    background: var(--wing-color, #ffeb3b); animation: flap 0.15s infinite alternate; 
}
.butterfly::before, .swarm-butterfly::before { left: 0; border-radius: 50% 50% 5% 80%; transform-origin: right bottom; transform: rotate(-10deg); }
.butterfly::after, .swarm-butterfly::after { right: 0; border-radius: 50% 50% 80% 5%; transform-origin: left bottom; transform: rotate(10deg); }
.butterfly.blue { --wing-color: #00e5ff; }
.butterfly.orange { --wing-color: #ff9800; }
@keyframes flap { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(60deg); } }
@keyframes flutter {
    0% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(40px, -30px) rotate(15deg); }
    50% { transform: translate(0px, -60px) rotate(-15deg); }
    75% { transform: translate(-40px, -30px) rotate(10deg); }
    100% { transform: translate(0, 0) rotate(0deg); }
}

/* LAYERS */
#fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 20000; overflow: hidden; }
#hud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 25000; overflow: hidden; }

/* MAIN GAME CONTAINER WITH SCALING */
.game-column { 
    width: 420px; 
    display: flex; flex-direction: column; align-items: center; 
    z-index: 10000; position: relative;
    transform-origin: top center;
    transition: transform 0.1s ease-out;
}
.hidden { display: none !important; }

/* UI */
.top-bar { width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 10px; }
.bomb-anchor { position: absolute; width: 150px; height: 150px; top: 10px; z-index: 20; }
.score-bomb { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }

/* --- SUN ANIMATION --- */
.sun-svg { 
    width: 100%; height: 100%; position: absolute; overflow: visible; 
    transition: opacity 2s, filter 0.5s ease;
    transform-origin: 50% 50%;
    animation: sun-breathe ease-in-out infinite; 
}
.grad-start, .grad-end, .sun-rays-shape, .sun-body { transition: stop-color 0.5s, fill 0.5s, stroke 0.5s; }
.sun-rays-shape { fill: #f39c12; }
@keyframes sun-breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(var(--scale-factor, 1.02)); } }

/* --- HEAT LEVELS (0-10) --- */
.bomb-heat-0 .sun-svg { animation-duration: 4s; --scale-factor: 1.02; filter: drop-shadow(0 0 5px rgba(241, 196, 15, 0.4)); }
.bomb-heat-0 .sun-rays-shape { fill: #f1c40f; }

.bomb-heat-1 .sun-svg, .bomb-heat-2 .sun-svg { animation-duration: 3.5s; --scale-factor: 1.03; filter: drop-shadow(0 0 15px rgba(243, 156, 18, 0.6)); }
.bomb-heat-1 .sun-rays-shape, .bomb-heat-2 .sun-rays-shape { fill: #f39c12; }

.bomb-heat-3 .sun-svg, .bomb-heat-4 .sun-svg { animation-duration: 3s; --scale-factor: 1.05; filter: drop-shadow(0 0 10px rgba(230, 126, 34, 0.8)) drop-shadow(0 0 20px rgba(230, 126, 34, 0.4)); }
.bomb-heat-3 .sun-rays-shape, .bomb-heat-4 .sun-rays-shape { fill: #e67e22; }

.bomb-heat-5 .sun-svg, .bomb-heat-6 .sun-svg { animation-duration: 2.5s; --scale-factor: 1.08; filter: drop-shadow(0 0 15px rgba(211, 84, 0, 0.9)) drop-shadow(0 0 30px rgba(211, 84, 0, 0.6)); }
.bomb-heat-5 .sun-rays-shape, .bomb-heat-6 .sun-rays-shape { fill: #d35400; }
.bomb-heat-5 .grad-start, .bomb-heat-6 .grad-start { stop-color: #f39c12; } 
.bomb-heat-5 .grad-end, .bomb-heat-6 .grad-end { stop-color: #d35400; }

.bomb-heat-7 .sun-svg, .bomb-heat-8 .sun-svg { animation-duration: 1.5s; --scale-factor: 1.12; filter: drop-shadow(0 0 10px rgba(255, 69, 0, 1)) drop-shadow(0 0 30px rgba(192, 57, 43, 0.8)) drop-shadow(0 0 50px rgba(192, 57, 43, 0.4)); }
.bomb-heat-7 .sun-rays-shape, .bomb-heat-8 .sun-rays-shape { fill: #c0392b; }
.bomb-heat-7 .grad-start, .bomb-heat-8 .grad-start { stop-color: #e67e22; } 
.bomb-heat-7 .grad-end, .bomb-heat-8 .grad-end { stop-color: #c0392b; }

.bomb-heat-9 .sun-svg, .bomb-heat-10 .sun-svg { animation-duration: 0.6s; --scale-factor: 1.25; filter: drop-shadow(0 0 15px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 40px rgba(255, 0, 0, 1)) drop-shadow(0 0 80px rgba(255, 0, 0, 0.8)); }
.bomb-heat-9 .sun-rays-shape, .bomb-heat-10 .sun-rays-shape { fill: #ff0000 !important; }
.bomb-heat-9 .grad-start, .bomb-heat-10 .grad-start { stop-color: #ff4500; } 
.bomb-heat-9 .grad-end, .bomb-heat-10 .grad-end { stop-color: #8a0303; }

.digital-display { position: relative; z-index: 10; color: #d35400; font-family: 'Fredoka One', cursive; font-size: 32px; text-shadow: 1px 1px 0px rgba(255,255,255,0.5); }
.bomb-heat-9 .digital-display, .bomb-heat-10 .digital-display { color: #fff; text-shadow: 0 0 10px #ff0000; }

#grid-wrapper {
    background: rgba(255, 255, 255, 0.25);
    padding: 10px; border-radius: 12px; width: 404px; height: 404px;
    position: relative; overflow: visible; 
    border: 2px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 10px 30px rgba(0, 50, 150, 0.15); margin-top: 10px;
}
#grid { display: grid; grid-template-columns: repeat(8, 44px); gap: 4px; padding: 4px; position: relative; z-index: 1; }
.cell { width: 44px; height: 44px; background: rgba(0, 0, 0, 0.05); border-radius: 8px; border: 2px solid transparent; }
.cell.occupied, .block { background-color: var(--block-color); box-shadow: inset 3px 3px 6px rgba(255,255,255,0.5), inset -2px -2px 6px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4); border-radius: 8px; }

/* --- GHOST & PREVIEW SYSTEM --- */
.cell.ghost { 
    background-color: var(--block-color); 
    opacity: 0.5; border-radius: 8px; 
    border: 2px solid rgba(255,255,255,0.9);
    box-shadow: 0 0 15px var(--block-color), inset 0 0 15px var(--block-color);
    z-index: 100;
    animation: preview-pulse 0.8s ease-in-out infinite alternate;
}

.cell.ghost-clear { 
    background-color: var(--preview-color) !important; 
    border: 2px solid rgba(255,255,255,0.9);
    box-shadow: 0 0 15px var(--preview-color), inset 0 0 15px var(--preview-color);
    z-index: 100;
    animation: preview-pulse 0.8s ease-in-out infinite alternate;
}
@keyframes preview-pulse { 0% { opacity: 0.4; } 100% { opacity: 0.6; } }

/* --- CLEARING: HARMONIC IMPLOSION --- */
.clearing { 
    animation: flash-implode 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
    z-index: 100; 
}
@keyframes flash-implode {
    0% { transform: scale(1); filter: brightness(1); opacity: 1; }
    30% { transform: scale(1.1); filter: brightness(8) drop-shadow(0 0 10px #fff); background-color: #fff; opacity: 1; }
    100% { transform: scale(0); filter: brightness(10); opacity: 0; }
}

.cell.impact { z-index: 100; transition: transform 0.1s; transform: scale(0.9); }

/* --- PLACEMENT: LINGERING GOLDEN GLOW --- */
.cell.just-placed {
    z-index: 105; position: relative;
    animation: golden-cooldown 0.6s ease-out forwards;
}
@keyframes golden-cooldown {
    0% { box-shadow: inset 0 0 20px #ffd700, 0 0 20px #ffd700; border-color: #fff; filter: brightness(1.3); }
    100% { box-shadow: inset 3px 3px 6px rgba(255,255,255,0.5), inset -2px -2px 6px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.4); filter: brightness(1); }
}

/* --- REVISED SNAPPY SHAKE ANIMATIONS --- */
.shake-1 { animation: snap-1 0.1s linear; }
@keyframes snap-1 { 
    0% { transform: translate(0, 0); } 
    25% { transform: translate(-2px, 0); } 
    75% { transform: translate(2px, 0); } 
    100% { transform: translate(0, 0); } 
}

.shake-2 { animation: snap-2 0.12s linear; }
@keyframes snap-2 { 
    0% { transform: translate(0, 0); } 
    25% { transform: translate(-4px, 2px); } 
    75% { transform: translate(4px, -2px); } 
    100% { transform: translate(0, 0); } 
}

.shake-3 { animation: snap-3 0.15s linear; }
@keyframes snap-3 { 
    0% { transform: translate(0, 0); } 
    20% { transform: translate(-6px, -4px); } 
    40% { transform: translate(6px, 4px); } 
    60% { transform: translate(-6px, 4px); } 
    80% { transform: translate(6px, -4px); } 
    100% { transform: translate(0, 0); } 
}

#tray { width: 100%; margin-top: 30px; display: flex; justify-content: space-between; height: 120px; position: relative; overflow: visible; }
.tray-slot { width: 120px; height: 120px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 16px; display: flex; justify-content: center; align-items: center; position: relative; overflow: visible; }
.piece { position: relative; pointer-events: none; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
.block { width: 26px; height: 26px; position: absolute; background-color: var(--block-color); box-shadow: inset 3px 3px 6px rgba(255,255,255,0.5), inset -2px -2px 6px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4); border-radius: 8px; }
.piece.dragging { position: fixed; z-index: 100000 !important; opacity: 1 !important; filter: drop-shadow(0 0 15px rgba(255, 235, 59, 0.6)) saturate(1.2) brightness(1.1); transition: filter 0.1s; transform-origin: center center; }
.piece.dragging .block { width: 44px; height: 44px; border: 2px solid rgba(255,255,255,0.6); }

.floating-score { position: fixed; left: var(--start-x); top: var(--start-y); color: #fff; font-family: 'Fredoka One', cursive; font-size: 32px; pointer-events: none; z-index: 20006; text-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: translate(-50%, -50%); }
.score-animate { animation: score-travel 1s linear forwards; }
@keyframes score-travel { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 10% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; } 100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1); opacity: 0; } }

/* --- COMBO ANIMATION SPEC --- */
.combo-container {
    position: absolute;
    top: 52%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 10px; 
    z-index: 200;
    pointer-events: none;
    animation: combo-spring 0.98s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.combo-label {
    font-family: 'Kanit', sans-serif;
    font-style: italic;
    font-weight: 900;
    font-size: 55px;
    color: white;
    -webkit-text-stroke: 2px white;
    text-shadow: 0 0 20px var(--glow-color);
}

.combo-number {
    font-family: 'Kanit', sans-serif;
    font-style: italic;
    font-weight: 900;
    font-size: 88px;
    transform: translateY(8px);
    background: linear-gradient(to bottom, white 0%, var(--glow-color) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    -webkit-text-stroke: 2px white;
    filter: drop-shadow(0 0 20px var(--glow-color));
}

@keyframes combo-spring {
    0% { transform: translate(-50%, -60%) scale(0.5); opacity: 0; }
    40% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    100% { transform: translate(-50%, -55%) scale(0.9); opacity: 0; }
}

/* --- POSITIVE REINFORCEMENT ANIMATION --- */
.reinforcement-banner {
    position: absolute;
    top: 38%;
    left: 0;
    width: 100%;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(90deg, transparent 0%, var(--glow-color) 50%, transparent 100%);
    border-top: 2px solid var(--glow-color);
    border-bottom: 2px solid var(--glow-color);
    opacity: 0;
    z-index: 190;
    pointer-events: none;
    animation: banner-wipe 0.85s ease-out forwards;
    animation-delay: 0.7s;
}

.reinforcement-text {
    font-family: 'Rubik Mono One', sans-serif;
    font-size: 26px;
    letter-spacing: 5px;
    color: white;
    text-transform: uppercase;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

@keyframes banner-wipe {
    0% { opacity: 0; transform: scaleX(0); }
    20% { opacity: 1; transform: scaleX(1); }
    80% { opacity: 1; transform: scaleX(1); }
    100% { opacity: 0; transform: scaleX(1.2); }
}

.debris-shard { position: fixed; z-index: 9999; box-shadow: 0 0 10px #fff; }
#restart { position: absolute; right: -50px; background: rgba(255,255,255,0.2); border: 2px solid #fff; color: #fff; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-weight: bold; }
#game-over-overlay { position: fixed; inset: 0; background: rgba(79, 172, 254, 0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; }
.game-over-box { background: #fff; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
.game-over-box h1 { color: #ff6b6b; font-family: 'Fredoka One'; font-size: 50px; margin: 0 0 20px 0; }
#restart-overlay-btn { background: #1dd1a1; color: #fff; border: none; padding: 15px 30px; font-family: 'Varela Round'; font-weight: bold; font-size: 24px; cursor: pointer; border-radius: 50px; box-shadow: 0 5px 0 #10ac84; }
#restart-overlay-btn:active { transform: translateY(5px); box-shadow: none; }

/* --- FALLING FLORA --- */
.falling-flora { position: fixed; pointer-events: none; z-index: 20005; }
.flora-leaf { width: 14px; height: 14px; background: #27ae60; border-radius: 0 14px 0 14px; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
.flora-petal { width: 10px; height: 10px; background: #e91e63; border-radius: 50% 50% 50% 0; transform: rotate(45deg); box-shadow: 0 0 4px #ff80ab; }

/* --- UPDATED TOUCH POLISH (LANDING GEAR) --- */

/* State 1: Airborne (Free Dragging) */
.piece.dragging-touch {
    transform-origin: center center;
    /* Use the JS-provided base scale * 1.08 for subtle lift */
    transform: scale(calc(var(--base-scale) * 1.08)) !important;
    /* Deep shadow to maintain elevation illusion */
    filter: drop-shadow(0 25px 25px rgba(0,0,0,0.4)) saturate(1.3) brightness(1.1) !important;
    /* Smoothly morph between states */
    transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.15s ease;
}

/* State 2: Docking (Valid Placement Detected) */
.piece.dragging-touch.aligned {
    /* Smoothly shrink back to match the grid exactly */
    transform: scale(var(--base-scale)) !important;
    /* Keep the shadow so it still looks like it's hovering, just lower */
    filter: drop-shadow(0 15px 15px rgba(0,0,0,0.3)) saturate(1.2) brightness(1.05) !important;
}